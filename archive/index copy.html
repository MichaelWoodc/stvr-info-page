<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Airbnb Incident Timeline</title>
<style>
  body { font-family: Arial, sans-serif; background: #f2f2f2; margin:0; padding:0; }
  header { background: #2c3e50; color: white; text-align: center; padding: 1rem; font-size: 1.5rem; }
  .container { display: flex; flex-direction: column; padding: 1rem; gap: 1.5rem; }
  @media(min-width:768px){ .container { flex-direction: row; } }
  .timeline { flex: 2; }
  .card { background: white; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #3498db; box-shadow: 0 2px 6px rgba(0,0,0,0.1); word-break: break-word;}
  .card h3 { margin-top:0;color: #3498db; }
  .tags span { background: #e74c3c; color:white; padding:0.2rem 0.5rem; margin-right:0.3rem; margin-top:0.2rem; display:inline-block; border-radius:3px; font-size:0.8rem; }
  .media img, .media video { max-width: 100%; margin-top:0.5rem; border-radius:4px; display:block; }
  .form-container { flex: 1; background: white; padding: 1rem; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
  .form-container h2 { margin-top:0; color: #2c3e50; }
  .form-group { margin-bottom: 1rem; }
  label { display:block; margin-bottom:0.3rem; font-weight:bold; }
  input, select, textarea, button { width:100%; padding:0.5rem; font-size:1rem; border-radius:4px; border:1px solid #ccc; box-sizing:border-box; }
  button { background: #3498db; color:white; border:none; cursor:pointer; font-size:1rem; margin-top:0.5rem; }
  .car-section { background:#ecf0f1; padding:0.5rem; margin-bottom:0.5rem; border-radius:4px; }

  /* Table-based checkboxes */
  table { width: 100%; border-collapse: collapse; margin-top: 0.3rem; }
  table td { vertical-align: middle; padding: 0.2rem 0; }
  table td:first-child { width: 30px; }
  table td:last-child { text-align: left; }

  /* Drag & drop styles */
  .dropzone {
    border: 2px dashed #cbd5e1;
    padding: 0.6rem;
    border-radius: 6px;
    text-align: center;
    color: #475569;
    cursor: pointer;
    background: #fbfdff;
  }
  .dropzone.dragover {
    background: #eef6ff;
    border-color: #90cdf4;
  }
  .previews { margin-top: 0.5rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px,1fr)); gap: 0.5rem; }
  .preview-thumb { position: relative; border-radius: 6px; overflow: hidden; background: #fff; border: 1px solid #e2e8f0; }
  .preview-thumb img, .preview-thumb video { width: 100%; height: 100px; object-fit: cover; display:block; }
  .preview-remove { position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.6); color: #fff; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; font-size: 12px; }

  /* small screens */
  @media(max-width:420px){
    .previews { grid-template-columns: repeat(3, 1fr); gap: 0.4rem; }
  }
</style>
</head>
<body>

<header>Airbnb Incident Timeline</header>

<div class="container">
  <!-- Timeline Section -->
  <div class="timeline" id="timeline"></div>

  <!-- Form Section -->
  <div class="form-container">
    <h2>Add New Incident</h2>

    <!-- Basic Info -->
    <div class="form-group">
      <label>Date</label>
      <input type="date" id="date">
    </div>
    <div class="form-group">
      <label>Arrival Time</label>
      <input type="time" id="arrival">
    </div>
    <div class="form-group">
      <label>Departure Time</label>
      <input type="time" id="departure">
    </div>
    <div class="form-group">
      <label># of People (optional)</label>
      <input type="number" id="people" min="0">
    </div>

    <!-- Problems using table -->
    <div class="form-group">
      <label>Problems</label>
      <table>
        <tr>
          <td><input type="checkbox" value="Too many cars" class="problem-checkbox"></td>
          <td>Too many cars</td>
        </tr>
        <tr>
          <td><input type="checkbox" value="Too many people" class="problem-checkbox"></td>
          <td>Too many people</td>
        </tr>
        <tr>
          <td><input type="checkbox" value="Noise" class="problem-checkbox"></td>
          <td>Noise</td>
        </tr>
        <tr>
          <td><input type="checkbox" value="Trash" class="problem-checkbox"></td>
          <td>Trash</td>
        </tr>
      </table>
    </div>

    <!-- Overall Media -->
    <div class="form-group">
      <label>Overall Photos (up to 5, optional)</label>
      <div id="photosDrop" class="dropzone">Drag & drop photos here or click to choose files</div>
      <input type="file" id="photos" accept="image/*" multiple style="display:none;">
      <div id="photoPreviews" class="previews"></div>
    </div>
    <div class="form-group">
      <label>Overall Video (1, optional)</label>
      <div id="videoDrop" class="dropzone">Drag & drop one video here or click to choose a file</div>
      <input type="file" id="video" accept="video/*" style="display:none;">
      <div id="videoPreview" class="previews"></div>
    </div>

    <!-- Notes -->
    <div class="form-group">
      <label>Notes</label>
      <textarea id="notes" rows="3"></textarea>
    </div>

    <!-- Cars Section -->
    <div class="form-group">
      <label># of Cars (optional)</label>
      <select id="numCars">
        <option value="0">0</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
        <option value="10+">10+</option>
      </select>
    </div>
    <div id="carsContainer"></div>
    <button type="button" id="addCarBtn" style="display:none;">Add Another Car</button>

    <button onclick="addIncident()">Add Incident</button>
  </div>
</div>

<script>
/* ---------------------------
   State: files + autosave
   --------------------------- */
let photoFiles = [];      // File objects for overall photos (max 5)
let videoFile = null;     // File object for overall video (max 1)
let carPhotoFiles = [];   // files from per-car photo inputs (keeps same order as car sections if present)

const maxPhotos = 5;

/* --- states list used to create car sections --- */
const states = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];

/* ---------------------------
   DOM refs
   --------------------------- */
const photosInput = document.getElementById('photos');
const photosDrop = document.getElementById('photosDrop');
const photoPreviews = document.getElementById('photoPreviews');

const videoInput = document.getElementById('video');
const videoDrop = document.getElementById('videoDrop');
const videoPreview = document.getElementById('videoPreview');

const carsContainer = document.getElementById('carsContainer');
const numCarsSelect = document.getElementById('numCars');
const addCarBtn = document.getElementById('addCarBtn');

let extraCarCount = 0;

/* ---------------------------
   Helpers: previews & file add/remove
   --------------------------- */
function updatePhotoPreviews() {
  photoPreviews.innerHTML = '';
  photoFiles.forEach((file, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'preview-thumb';
    const img = document.createElement('img');
    img.src = URL.createObjectURL(file);
    img.onload = () => URL.revokeObjectURL(img.src);
    const btn = document.createElement('button');
    btn.className = 'preview-remove';
    btn.textContent = '✕';
    btn.addEventListener('click', () => {
      photoFiles.splice(idx, 1);
      updatePhotoPreviews();
    });
    wrap.appendChild(img);
    wrap.appendChild(btn);
    photoPreviews.appendChild(wrap);
  });
}

function setVideoPreview(file) {
  videoPreview.innerHTML = '';
  if (!file) return;
  const wrap = document.createElement('div');
  wrap.className = 'preview-thumb';
  const vid = document.createElement('video');
  vid.src = URL.createObjectURL(file);
  vid.controls = true;
  vid.onloadeddata = () => URL.revokeObjectURL(vid.src);
  const btn = document.createElement('button');
  btn.className = 'preview-remove';
  btn.textContent = '✕';
  btn.addEventListener('click', () => {
    videoFile = null;
    videoInput.value = '';
    setVideoPreview(null);
  });
  wrap.appendChild(vid);
  wrap.appendChild(btn);
  videoPreview.appendChild(wrap);
}

/* --- add files from input or drop --- */
function addPhotosFromList(list) {
  for (const f of list) {
    if (!f.type.startsWith('image/')) continue;
    if (photoFiles.length >= maxPhotos) break;
    photoFiles.push(f);
  }
  updatePhotoPreviews();
}
function setVideoFromFile(f) {
  if (!f) return;
  if (!f.type.startsWith('video/')) return;
  videoFile = f;
  setVideoPreview(f);
}

/* ---------------------------
   Drag & drop handlers
   --------------------------- */
function makeDropzone(dropEl, onFiles) {
  dropEl.addEventListener('click', () => {
    // open corresponding hidden input
    if (dropEl.id === 'photosDrop') photosInput.click();
    if (dropEl.id === 'videoDrop') videoInput.click();
  });
  dropEl.addEventListener('dragover', e => {
    e.preventDefault();
    dropEl.classList.add('dragover');
  });
  dropEl.addEventListener('dragleave', e => {
    dropEl.classList.remove('dragover');
  });
  dropEl.addEventListener('drop', e => {
    e.preventDefault();
    dropEl.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files || []);
    onFiles(files);
  });
}
makeDropzone(photosDrop, addPhotosFromList);
makeDropzone(videoDrop, files => setVideoFromFile(files[0]));

/* wire hidden inputs */
photosInput.addEventListener('change', (e) => addPhotosFromList(Array.from(e.target.files)));
videoInput.addEventListener('change', (e) => setVideoFromFile(e.target.files[0]));

/* ---------------------------
   Car sections handling
   --------------------------- */
function createCarSection(index) {
  const carDiv = document.createElement('div');
  carDiv.className = 'car-section';
  carDiv.dataset.index = index;
  carDiv.innerHTML = `
    <h4>Car ${index} (optional)</h4>
    <label>Style:</label>
    <select class="car-style">
      <option value="">Unknown</option>
      <option>Car</option>
      <option>Truck</option>
      <option>Van</option>
      <option>SUV</option>
      <option>Other</option>
    </select>
    <label>Color (optional):</label>
    <input type="text" class="car-color" placeholder="e.g., Red">
    <label>License Plate (optional):</label>
    <input type="text" class="car-license" placeholder="">
    <label><input type="checkbox" class="car-instate">In-State</label>
    <label>Out-of-State (optional)</label>
    <select class="car-state">${states.map(s=>`<option value="${s}">${s}</option>`).join('')}
      <option value="">Select State</option>
    </select>
    <label>Photo (optional)</label>
    <input type="file" class="car-photo" accept="image/*">
  `;
  carsContainer.appendChild(carDiv);

  // wire car photo change into carPhotoFiles array index
  const idx = carsContainer.children.length - 1;
  const fileInput = carDiv.querySelector('.car-photo');
  fileInput.addEventListener('change', () => {
    const file = fileInput.files[0] || null;
    carPhotoFiles[idx] = file;
  });
  // when fields change, autosave will pick up values (we save cars full set)
}

numCarsSelect.addEventListener('change', () => {
  // reset car photo files mapping when count changes
  carPhotoFiles = [];
  carsContainer.innerHTML = '';
  extraCarCount = 0;
  const val = numCarsSelect.value;
  const count = (val === '10+') ? 10 : Math.max(0, parseInt(val || '0'));
  for (let i=1; i<=count; i++) createCarSection(i);
  addCarBtn.style.display = (val === '10+') ? 'block' : 'none';
  saveToLocal(); // persist change
});

addCarBtn.addEventListener('click', () => {
  extraCarCount++;
  createCarSection(10 + extraCarCount);
});

/* ---------------------------
   Gather car data
   --------------------------- */
function gatherCars() {
  const carDivs = Array.from(document.querySelectorAll('.car-section'));
  const cars = carDivs.map((div, idx) => {
    const style = div.querySelector('.car-style').value;
    const color = div.querySelector('.car-color').value;
    const license = div.querySelector('.car-license').value;
    const instate = !!div.querySelector('.car-instate').checked;
    const state = div.querySelector('.car-state').value;
    // attach index so server can map car photo (if present as carPhotos[] in same order)
    return { style, color, license, instate, state };
  });
  return cars;
}

/* ---------------------------
   Autosave (localStorage) logic
   --------------------------- */
const autosaveKeys = ['date','arrival','departure','people','notes','numCars'];
function saveToLocal() {
  autosaveKeys.forEach(k => {
    const el = document.getElementById(k);
    if (el) localStorage.setItem(k, el.value || '');
  });
  // problems checkboxes
  document.querySelectorAll('.problem-checkbox').forEach(cb => {
    localStorage.setItem('problem-' + cb.value, cb.checked ? '1' : '');
  });
  // save cars (structure)
  const cars = gatherCars();
  localStorage.setItem('cars', JSON.stringify(cars));
}
function restoreFromLocal() {
  autosaveKeys.forEach(k => {
    const val = localStorage.getItem(k);
    if (val !== null && document.getElementById(k)) document.getElementById(k).value = val;
  });
  // problems
  document.querySelectorAll('.problem-checkbox').forEach(cb => {
    cb.checked = !!localStorage.getItem('problem-' + cb.value);
  });
  // restore cars after numCars triggers
  const carsJson = localStorage.getItem('cars');
  if (carsJson) {
    try {
      const cars = JSON.parse(carsJson);
      // ensure the right number of sections
      const desired = cars.length;
      if (desired > 0) {
        // set select appropriately
        if (desired >= 10) {
          numCarsSelect.value = '10+';
        } else {
          numCarsSelect.value = String(desired);
        }
        numCarsSelect.dispatchEvent(new Event('change'));
        // small timeout to ensure DOM sections created
        setTimeout(() => {
          const carDivs = Array.from(document.querySelectorAll('.car-section'));
          carDivs.forEach((div, i) => {
            const c = cars[i] || {};
            if (div.querySelector('.car-style')) div.querySelector('.car-style').value = c.style || '';
            if (div.querySelector('.car-color')) div.querySelector('.car-color').value = c.color || '';
            if (div.querySelector('.car-license')) div.querySelector('.car-license').value = c.license || '';
            if (div.querySelector('.car-instate')) div.querySelector('.car-instate').checked = !!c.instate;
            if (div.querySelector('.car-state')) div.querySelector('.car-state').value = c.state || '';
          });
        }, 120);
      }
    } catch(e){}
  }
}

/* attach autosave listeners */
['date','arrival','departure','people','notes','numCars'].forEach(id=>{
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', saveToLocal);
});
document.querySelectorAll('.problem-checkbox').forEach(cb => cb.addEventListener('change', saveToLocal));

/* restore on load */
window.addEventListener('load', () => {
  // populate form fields from storage
  restoreFromLocal();
  // initial previews empty
  updatePhotoPreviews();
  setVideoPreview(videoFile);
  // load existing incidents from server
  loadIncidents();
});

/* ---------------------------
   Submit to server (PHP save_incident.php)
   --------------------------- */
function addIncident(){
  // gather form data
  const date = document.getElementById('date').value;
  const arrival = document.getElementById('arrival').value;
  const departure = document.getElementById('departure').value;
  const people = document.getElementById('people').value;
  const notes = document.getElementById('notes').value;
  const problems = Array.from(document.querySelectorAll('.problem-checkbox:checked')).map(cb => cb.value);
  const cars = gatherCars();

  // build formdata
  const fd = new FormData();
  fd.append('date', date);
  fd.append('arrival', arrival);
  fd.append('departure', departure);
  fd.append('people', people);
  fd.append('notes', notes);
  fd.append('problems', JSON.stringify(problems));
  fd.append('cars', JSON.stringify(cars));

  // overall photos
  photoFiles.forEach(f => fd.append('photos[]', f));
  // car photos (if any) appended as carPhotos[] in same order as car sections (so server can map)
  // gather current car photo inputs
  const carPhotoInputs = Array.from(document.querySelectorAll('.car-photo'));
  carPhotoInputs.forEach(inp => {
    if (inp.files && inp.files[0]) fd.append('carPhotos[]', inp.files[0]);
  });

  // video
  if (videoFile) fd.append('video', videoFile);

  // submit
  fetch('save_incident.php', { method: 'POST', body: fd })
    .then(r => r.json())
    .then(resp => {
      if (resp && resp.success) {
        // clear UI and localStorage
        photoFiles = [];
        videoFile = null;
        carPhotoFiles = [];
        updatePhotoPreviews();
        setVideoPreview(null);
        document.getElementById('photos').value = '';
        document.getElementById('video').value = '';
        // clear fields
        ['date','arrival','departure','people','notes'].forEach(id => {
          if (document.getElementById(id)) document.getElementById(id).value = '';
        });
        document.querySelectorAll('.problem-checkbox').forEach(cb => cb.checked = false);
        numCarsSelect.value = '0';
        carsContainer.innerHTML = '';
        addCarBtn.style.display = 'none';
        // clear local storage
        ['date','arrival','departure','people','notes','numCars'].forEach(k => localStorage.removeItem(k));
        document.querySelectorAll('.problem-checkbox').forEach(cb => localStorage.removeItem('problem-'+cb.value));
        localStorage.removeItem('cars');
        // reload incidents list
        loadIncidents();
        alert('Incident saved');
      } else {
        console.error('Save response', resp);
        alert('Save failed (see console)');
      }
    })
    .catch(err => {
      console.error('Save error', err);
      alert('Save failed (network)');
    });
}

/* ---------------------------
   Load incidents from server (get_incidents.php)
   --------------------------- */
function loadIncidents() {
  fetch('get_incidents.php')
    .then(r => r.json())
    .then(data => {
      const timeline = document.getElementById('timeline');
      timeline.innerHTML = '';
      if (!Array.isArray(data)) { timeline.innerHTML = '<p>No incidents yet.</p>'; return; }
      data.forEach(inc => {
        const card = document.createElement('div');
        card.className = 'card';
        const problemsText = (inc.problems && inc.problems.length) ? inc.problems.map(p=>`<span class="tags"><span style="background:#e74c3c;color:#fff;padding:2px 6px;border-radius:3px">${p}</span></span>`).join(' ') : '';
        const photosHtml = (inc.photos||[]).map(p => `<img src="uploads/${inc.folder}/${p}" alt="photo">`).join('');
        const videoHtml = inc.video ? `<video src="uploads/${inc.folder}/${inc.video}" controls></video>` : '';
        let carsHtml = '';
        if (inc.cars && inc.cars.length) {
          carsHtml = '<h4>Cars:</h4>' + inc.cars.map(c => {
            const colorPart = c.color ? ` (${c.color})` : '';
            const platePart = c.license ? ` - ${c.license}` : '';
            const statePart = (c.instate ? 'In-State' : (c.state ? 'Out-of-State: ' + c.state : 'Out-of-State'));
            return `<p>${c.style || 'Unknown'}${colorPart}${platePart} | ${statePart}</p>`;
          }).join('');
        }
        card.innerHTML = `
          <h3>${inc.date || inc.timestamp}</h3>
          <p><strong>Arrival:</strong> ${inc.arrival || ''} | <strong>Departure:</strong> ${inc.departure || ''}</p>
          ${inc.people ? `<p><strong>People:</strong> ${inc.people}</p>` : ''}
          <div>${problemsText}</div>
          <div class="media">${photosHtml}${videoHtml}</div>
          ${inc.notes ? `<p><strong>Notes:</strong> ${inc.notes}</p>` : ''}
          ${carsHtml}
        `;
        timeline.appendChild(card);
      });
    })
    .catch(err => {
      console.error('Load failed', err);
      document.getElementById('timeline').innerHTML = '<p>Failed to load incidents.</p>';
    });
}
</script>

</body>
</html>
